<!--
@license
Code developed by Dorian Brown in collaboration with Codeself, Inc.
-->

<!-- Polymer -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- Paper Elements -->
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<!-- Polymerfire Elements -->
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-query.html">

<!-- Iron Elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../../bower_components/iron-selector/iron-multi-selectable.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">

<!-- Vaadin Elements -->
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-combo-box.html">
<link rel="import" href="../../bower_components/vaadin-form-layout/vaadin-form-layout.html">

<!-- Icons -->
<link rel="import" href="../app-icons.html">
<link rel="import" href="../fa-icons.html">

<!-- Shared Style  -->
<link rel="import" href="../shared-styles.html">

<dom-module id="wrc-programs">
	<template>
		<style include="wrc-shared-styles">
			/* General Style */

			main {
				padding: 1em 0em 2em 0em;
				height: calc(100vh - (64px + 4em));
				min-height: calc(100vh - (64px + 4em));
				overflow: auto;
			}

			/* Header Section */

			div.title {
				@apply --layout-horizontal;
				@apply --layout-center-justified;
			}

			paper-icon-button.back-button {
				margin: 10px 0 0 15px;
			}

			.header-section {
				@apply --layout-horizontal;
			}

			div.title h3 {
				font-size: 1.6em;
				font-weight: 400;
				font-style: normal;
				font-stretch: normal;
				line-height: normal;
				letter-spacing: 1px;
				color: #6a7582;
				margin: -38px 0 20px 0;

				@apply --layout-center;
				@apply --layout-vertical;
			}

			/* Paper Fab */

			paper-fab.finish-button {
				--paper-fab-background: #5ac381;
				--paper-fab-keyboard-focus-background: #5ac381;
			}

			/* Iron Selector */

			iron-selector {
				@apply --layout-wrap;
				@apply --layout-horizontal;
			}

			.menu-item-selected {
				border-style: none;
				background-color: white;
			}

			.paper-form.iron-selected {
				border-style: solid;
				border-color: rgb(66, 141, 255, .60);
				border-width: medium;
				color: white;

				box-shadow: 0 8px 40px 0 rgba(0, 0, 0, 0.10);
			}

			.option-menu .iron-selected {
				text-transform: none;
				font-weight: normal;
				background-color: white !important;
			}

			.option-menu paper-item {
				text-transform: none;
				font-weight: normal;
				text-decoration: none;

				--paper-item-selected: red;

			}

			/* PDF Workout */

			.menu-icon {
				margin-left: 10em;
				color: #86919f;
			}

			.menu-icon:hover {
				color: #636E7A;
			}

			.paper-form {
				position: relative;
				/* z-index: 102; */
			}

			.paper-form>.pdf-wrapper {
				@apply --layout-vertical;
				@apply --layout-center;
			}

			.content-wrapper {
				display: block;
				margin: .5cm auto 0 auto;
			}

			.start-button {
				width: 110px;
				height: 30px;
				border-radius: 3.1px;
				background-color: #5ac381;
				box-shadow: 0 4px 15px 0 rgba(90, 195, 129, 0.54);
				margin: 60px 0 0 0;

				@apply --layout-vertical;
				@apply --layout-center-center;
			}

			.start-button>.title {
				font-size: 1em;
				font-weight: 400;
				letter-spacing: 0.4px;
				text-align: center;
				color: white;
			}

			.option-menu paper-icon-button {
				/* z-index: 105; */
			}

			[hidden] {
				display: none;
			}

			/* Responsive */

			@media screen and (max-width: 600px) {
				div.title h3 {
					font-size: 1.4em;
				}

				div.collection-wrapper {
					@apply --layout-wrap;
					@apply --layout-vertical;
					@apply --layout-center;
				}
			}
		</style>

		<!-- Firebase Document Configuration -->
		<firebase-document id="firebaseDocument" app-name="wrc_software"></firebase-document>

		<!-- Workouts Query Configuration -->
		<firebase-query app-name="wrc_software" path="workouts" data="{{workoutsData}}" order-by-child="status" equal-to="false"></firebase-query>

		<!-- Programs Query Configuration -->
		<firebase-query app-name="wrc_software" path="programs" data="{{programsData}}"></firebase-query>

		<!-- Element UI -->
		<main>

			<div hidden$="{{hidden}}">

				<!-- Program Cards -->
				<div class="collection-wrapper">
					<template is=dom-repeat items="{{programsData}}" as="program">
						<div class="paper-form" hidden$="[[_computeHiddenPrograms(reviewMode, editMode)]]" id$="[[program.$key]]">
							<div class="pdf-wrapper">
								<paper-menu-button id="programMenu" horizontal-align="right" vertical-align="top" horizontal-offset="10" vertical-offset="0"
								    class="option-menu">
									<paper-icon-button class="menu-icon default-transiton" noink slot="dropdown-trigger" icon="app-icons:more-vert" alt="menu"></paper-icon-button>
									<paper-listbox noink slot="dropdown-content" selected="{{selectedMenuItem}}">
										<paper-item id$="[[program.$key]]" on-tap="_reviewProgram" data-option="review">Review</paper-item>
										<paper-item id$="[[program.$key]]" on-tap="_editProgram" data-option="edit">Edit</paper-item>
										<paper-item id$="[[program.$key]]" on-tap="_openDeleteProgramDialog">Delete</paper-item>
									</paper-listbox>
								</paper-menu-button>

								<!-- card content -->
								<div class="content-wrapper">
									<div class="season-title-program">[[program.program]]</div>
									<div class="program-title">[[program.duration]] Program</div>
									<div class="type-title">[[program.type]]</div>
								</div>
								<div class="tag">
									<div class="day-title">[[program.days]] Days</div>
								</div>
							</div>
						</div>
					</template>
				</div>

				<!-- Paper Fab to add new workout -->
				<paper-fab src="../icons/fab-icon/plus-icon@3x.png" hidden$="{{reviewMode}}" on-tap="_openToAdd"></paper-fab>

			</div>

			<!-- Review Workouts content -->
			<div hidden$="{{!reviewMode}}">
				<p>this is the review</p>
				<!-- Back button -->
				<paper-icon-button noink class="back-button" alt="Back" src="../icons/buttons/left-arrow.svg" on-tap="_backToPrograms"></paper-icon-button>
			</div>

			<!-- Edit Workouts content -->
			<div hidden$="{{!editMode}}">
				<!-- Back button -->
				<paper-icon-button noink class="back-button" alt="Back" src="../icons/buttons/left-arrow.svg" on-tap="_backToPrograms"></paper-icon-button>

				<div class="title">
					<h3>Select Workouts for Program</h3>
					<p>this is the edit mode</p>
				</div>
			</div>

			<!-- Workouts Cards Selector
			<iron-selector multi hidden$="[[editMode]]">
				<template is=dom-repeat items="{{workoutsData}}" as="workout">
					<div class="paper-form" id$="[[workout.$key]]">
						<div class="pdf-wrapper">
							<div class="content-wrapper">
								<div class="season-title-workout">[[workout.season]]</div>
								<div class="program-title">[[workout.weeks]] Week Program</div>
								<div class="type-title">[[workout.type]]</div>
							</div>
							<div class="tag">
								<div class="day-title">Week [[workout.week]]</div>
							</div>
						</div>
					</div>
				</template>
			</iron-selector>
			-->

			<!-- Finish button -->
			<paper-fab src="../icons/fab-icon/check-mark.png" hidden$="{{!editMode}}" on-tap="_bindWorkoutsToProgram" class="finish-button"></paper-fab>

		</main>
	</template>

	<script>
		'use strict';

		(function () {
			class WrcPrograms extends Polymer.Element {
				// Element definition
				static get is() {
					return 'wrc-programs';
				}

				/**
				 * Element properties
				 */
				static get properties() {
					return {
						hidden: {
							type: Boolean,
							notify: true,
							value: false
						},
						reviewMode: {
							type: Boolean,
							notify: true,
							value: false
						},
						editMode: {
							type: Boolean,
							notify: true,
							value: false
						},
						selectedMenuItem: {
							type: Object,
							notify: true,
							value: null
						},

					}
				};

				ready() {
					super.ready();

					// Add Program Dialog
					this._addProgramDialog = document.getElementById('addProgramDialog');

					// App Toast
					this._appToast = document.getElementById("appToast");

					// App Progress bar
					this._appProgress = document.getElementById("appProgressBar");

					// Delete Workout Dialog
					this._deleteProgramDialog = document.getElementById("appDeleteDialog");
				}

				_computeHiddenPrograms(reviewMode, editMode) {
					if (reviewMode || editMode) {
						return true;
					}
					return false;
				}

				/**
				 * Reset 'paper-menu-button' user selection
				 */
				_resetMenuSelection() {
					this.selectedMenuItem = null;
				}

				/**
				 * Opens program dialog to add
				 */
				_openToAdd() {
					this._addProgramDialog.acceptedCallback = this._onProgramDialog.bind(this);
					this._addProgramDialog.opened = true;
				}

				/**
				 * Opens delete program dialog
				 */
				_openDeleteProgramDialog(e) {
					this.programId = e.target.getAttribute("id");

					// Binding confirmation action
					this._deleteProgramDialog.acceptedCallback = this._deleteProgram.bind(this);

					this._deleteProgramDialog.opened = true;
					this._deleteProgramDialog.title = "Delete Program";
					this._deleteProgramDialog.msg = "Are you sure you want to delete this Program?";
					// TODO: Improve UX + Add More Detailed info.: All workouts from this program will release back to the workout collection.
				}

				/**
				 * @description Deletes Program and releases all binded workouts
				 */
				_deleteProgram(response) {
					if (response) {
						this.$.firebaseDocument.getStoredValue("programs/" + this.programId + "/workouts")
							.then(function (workouts) {
								if (workouts && workouts.length) {
									for (let workout of workouts) {
										this.$.firebaseDocument.setStoredValue("workouts/" + workout + "/status", false);
									}
								}
								this.$.firebaseDocument.destroy("programs/" + this.programId);
								this._appToast.text = "The workout has been deleted successfully.";
								this._appToast.open();
								this._deleteProgramDialog.opened = false;
							}.bind(this));
					}
				}

				/**
				 * Saves new program
				 */
				_onProgramDialog(programInfo) {
					this._appProgress.hidden = false;
					this.$.firebaseDocument.push("programs", programInfo)
						.then(function () {
							this._appProgress.hidden = true;
							this._appToast.text = "The program has been created succesfully.";
							this._appToast.open();
							this._addProgramDialog.resetForm();
							this._addProgramDialog.opened = false;
						}.bind(this))
						.catch(function (err) {
							this._appProgress.hidden = true;
							this._appToast.text = "There has been an error. Please try again.";
							this._appToast.open();
						}.bind(this));
				}

				_backToPrograms() {
					this.editMode = this.reviewMode = false;
				}

				_reviewProgram(evt) {
					this.reviewMode = true;
					this.programId = evt.target.getAttribute("id");
				}

				_editProgram(evt) {
					this.editMode = true;
					this.programId = evt.target.getAttribute("id");
				}

				/**
				 * Element Hidden functionality
				 *
				 * @param {Boolean} return true to hide content
				 * @return {Boolean}
				 */
				_isHidden(e) {
					var reviewMode = this.reviewMode;
					var editMode = this.editMode;

					// Extracts id of clicked program
					const programId = e.target.getAttribute("id");

					// Assigns the id to a global variable to can access it from any other function
					this.programId = (programId) ? programId : null;

					// Review program's workout collection
					if (reviewMode) {
						// view program workout collection
						this.reviewMode = !this.reviewMode;
						this._resetMenuSelection();

					} else {
						// view program
						this.reviewMode = !this.reviewMode;
						this._resetMenuSelection();
					}

					// TODO: Finish Edit Mode
					/*
					// Edit program's workout collection
					console.log(editMode);
					if(editMode) {
						// view selectable workout collection
						this.editMode = !this.editMode;
						this.hidden = true;
						this._resetMenuSelection();
					} else {
						// view program
						this.editMode = !this.editMode;
						this.hidden = true;
						this._resetMenuSelection();
					}
					*/
				}


				/**
				 * Program Modes
				 *
				 */
				_computeModeVisibilty(e) {

					// Read data attribute
					var mode = e.target.dataset.option;

					if (mode == 'review') {
						console.log("Review");
						console.log(!this.reviewMode);

						this.reviewMode = !this.reviewMode;

					} else if (mode == 'edit') {

						this.editMode = !this.editMode;
					}
				}


				/**
				 * Binds selected workouts to program
				 */
				_bindWorkoutsToProgram() {
					const selectableWorkouts = this.root.querySelector("iron-selector");
					const selectedWorkouts = selectableWorkouts.querySelectorAll(".iron-selected");
					if (selectedWorkouts && selectedWorkouts.length > 0) {
						this._appProgress.hidden = false;
						let bindedWorkouts = [];
						for (let i = 0; i < selectedWorkouts.length; i++) {
							const workoutId = selectedWorkouts[i].id;
							bindedWorkouts.push(workoutId);
							this.$.firebaseDocument.setStoredValue("workouts/" + workoutId + "/status", true);
						}
						console.log(bindedWorkouts);
						this.$.firebaseDocument.setStoredValue("programs/" + this.programId + "/workouts", bindedWorkouts)
							.then(function () {
								this._appProgress.hidden = true;
								this._appToast.text = "The workouts has been assigned succesfully.";
								this._appToast.open();
								this.hidden = false;
							}.bind(this))
							.catch(function (err) {
								this._appProgress.hidden = true;
								this._appToast.text = "There has been an error. Please try again.";
								this._appToast.open();
							}.bind(this));
					} else {
						this._appToast.text = "Please select at least one workout";
						this._appToast.open();
					}
				}
			}
			window.customElements.define(WrcPrograms.is, WrcPrograms);
		}());
	</script>
</dom-module>
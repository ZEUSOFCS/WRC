<!--
@license
Code developed by Dorian Brown in collaboration with Codeself, Inc.
-->

<!-- Polymer -->
<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<!-- Paper Elements -->
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<!-- Iron Elements -->
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<!-- Polymerfire Elements -->
<link rel="import" href="../../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../../bower_components/polymerfire/firebase-auth.html">

<!-- Vaadin Elements -->
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-valo-theme/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-selection-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-column.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid-sorter.html">

<!-- Polyfilter -->
<link rel="import" href="../../bower_components/poly-filter/poly-filter-diacritic.html">

<!-- Suji Elements -->
<link rel="import" href="../suji/lib/themes/azul/azul-theme.html">
<link rel="import" href="../suji/lib/colors/suji-color-palette.html">

<!-- Neon Elements -->
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/neon-animation/web-animations.html">

<!-- Icons -->
<link rel="import" href="../app-icons.html">
<link rel="import" href="../fa-icons.html">

<dom-module id="wrc-athletes">
    <template>
        <style>
            /* General Style */
            main {
                padding: 2em 3em;
                height: calc(100vh - (64px + 4em));
                min-height: calc(100vh - (64px + 4em));
                overflow: auto;

                @apply --layout-vertical;
                @apply --layout-center;
            }

            paper-spinner {
                --paper-spinner-layer-1-color: var(--azul-primary);
                --paper-spinner-layer-2-color: var(--azul-primary);
                --paper-spinner-layer-3-color: var(--azul-primary);
                --paper-spinner-layer-4-color: var(--azul-primary);
            }

            [flex] {
                @apply --layout-flex;
            }

            /* Empty Message */
            .empty-message {
                width: 100%;
                height: inherit;

                @apply --layout-vertical;
                @apply --layout-center-center;
            }

            .empty-message .icon-container {
                border-radius: 300em;
                width: 200px;
                height: 200px;
                background-color: var(--azul-text-title);
                box-shadow: 0 3.5px 12.5px 0 rgba(0, 0, 0, 0.25);

                @apply --layout-vertical;
                @apply --layout-center-center;
            }

            .icon-container iron-icon {
                color: #fff;
                width: 90px;
                height: 90px;
            }

            .empty-message p {
                margin-top: 24px;
                text-align: center;

                @apply --layout-vertical;
                @apply --layout-center-center;
            }

            .empty-message p strong {
                font-size: 1.2em;
                font-weight: bold;
                color: var(--azul-text-title);
                margin-bottom: 15px;
                text-align: center;
            }

            .empty-message p span {
                font-size: 1em;
                font-weight: lighter;
                color: var(--paper-grey-600);
                margin-bottom: 24px;
                text-align: center;
            }

            .empty-message p paper-button {
                margin: 0;
                color: #fff;
                background-color: var(--azul-primary);
            }

            /* Athletes Wrapper */
            div.athletes-wrapper {
                width: 100%;
            }

            div.athletes-wrapper[hidden] {
                display: none;
            }

            /* Search Style */
            div.search-wrapper {
                width: 100%;
                margin-bottom: 24px;
            }

            div.search-wrapper vaadin-text-field {
                width: 100%;
            }

            div.search-wrapper vaadin-text-field [slot='prefix']{
                margin-right: 12px;
                color: var(--paper-grey-500);
            }

            /* Grid Wrapper */
            div.grid-wrapper {
                width: 100%;
            }

            div.grid-wrapper vaadin-grid {
                width: inherit;
                height: auto;
                box-shadow: 0 2px 10px 0 rgba(0, 0, 20, 0.25);
            }

            div.grid-wrapper vaadin-grid iron-icon {
				width: 17px;
                height: 17px;
			}

			div.grid-wrapper vaadin-grid iron-icon[active='Yes'] {
				color: #35BF2E;
			}

			div.grid-wrapper vaadin-grid iron-icon[active='No'] {
				color: var(--paper-grey-500);
			}

            div.grid-wrapper vaadin-grid vaadin-grid-cell-content div.actions {
				@apply --layout-horizontal;
				@apply --layout-wrap;
				@apply --layout-end-justified;
			}

			div.grid-wrapper vaadin-grid vaadin-grid-cell-content div.actions paper-icon-button {
				color: #737D8A;
			}

			div.grid-wrapper vaadin-grid vaadin-grid-cell-content div.actions paper-icon-button:hover {
				color: #425164;
			}

            /* Fab */
            paper-fab {
                position: fixed;
                bottom: 2em;
                right: 2em;

                --paper-fab-background: var(--azul-primary);
                --paper-fab-keyboard-focus-background: var(--azul-primary);
            }

            [hidden] {
                display: none;
            }
        </style>

        <!-- This media query matches small screens to hide the grid and show responsive cards -->
        <iron-media-query query="(max-width: 600px)" query-matches="{{responsiveScreen}}"></iron-media-query>

        <!-- Firebase Document Configuration -->
        <firebase-document
            id="firebaseDocument"
            app-name="wrc_software"></firebase-document>

        <main>
            <template is="dom-if" if="[[!userReady]]">
                <paper-spinner active></paper-spinner>
            </template>

            <!-- Empty Teams Message -->
            <div class="empty-message" hidden$="[[!_computeVisibleEmptyMessage(athletesData.length, userReady)]]">
                <div class="icon-container">
                    <iron-icon icon="app-icons:person"></iron-icon>
                </div>
                <p>
                    <strong>You don't have athletes</strong>
                    <span>Add an athlete and it will show up here</span>
                    <paper-button raised on-tap="_openToAdd">Add Athlete</paper-button>
                </p>
            </div>

            <!-- Athletes Wrapper -->
            <div class="athletes-wrapper" hidden$="[[!_computeVisibleData(athletesData.length, userReady)]]">
                <!-- Search filter -->
                <div class="search-wrapper">
                    <poly-filter-diacritic
                        filter="[[athleteFilter]]"
                        array-to-filter="[[athletesData]]"
                        filtered-array="{{athletesDataFiltered}}"
                        filter-by="first, last"></poly-filter-diacritic>

                    <vaadin-text-field
                        placeholder="Search"
                        type="search"
                        value="{{athleteFilter}}">
                        <iron-icon slot="prefix" icon="app-icons:search"></iron-icon>
                    </vaadin-text-field>
                </div>

                <!-- Grid View -->
                <template is="dom-if" if="[[!responsiveScreen]]">
                    <div class="grid-wrapper">
                        <vaadin-grid aria-label="Coaches Grid" items="[[athletesDataFiltered]]">
                            <vaadin-grid-selection-column auto-select></vaadin-grid-selection-column>

                            <!-- Athlete number -->
                            <vaadin-grid-column width="70px" flex-grow="0">
                                <template class="header">
                                    <vaadin-grid-sorter path="number">#</vaadin-grid-sorter>
                                </template>
                                <template>[[item.number]]</template>
                            </vaadin-grid-column>
                            
                            <vaadin-grid-column width="100px" flex-grow="0">
                                <template class="header">
                                    <vaadin-grid-sorter path="active">Active</vaadin-grid-sorter>
                                </template>
                                <template>
                                    <iron-icon icon="app-icons:dot" active$="[[item.active]]"></iron-icon>
                                </template>
                            </vaadin-grid-column>

                            <!-- First Name -->
                            <vaadin-grid-column>
                                <template class="header">
                                    <vaadin-grid-sorter path="first">First</vaadin-grid-sorter>
                                </template>
                                <template>[[item.first]]</template>
                            </vaadin-grid-column>

                            <!-- Last Name -->
                            <vaadin-grid-column>
                                <template class="header">
                                    <vaadin-grid-sorter path="last">Last</vaadin-grid-sorter>
                                </template>
                                <template>[[item.last]]</template>
                            </vaadin-grid-column>

                            <!-- Position -->
                            <vaadin-grid-column>
                                <template class="header">
                                    <vaadin-grid-sorter path="pos">Position</vaadin-grid-sorter>
                                </template>
                                <template>[[item.pos]]</template>
                            </vaadin-grid-column>

                            <!-- Year -->
                            <vaadin-grid-column width="100px" flex-grow="0">
                                <template class="header">
                                    <vaadin-grid-sorter path="year">Year</vaadin-grid-sorter>
                                </template>
                                <template>[[item.year]]</template>
                            </vaadin-grid-column>

                            <!-- Actions -->
                            <vaadin-grid-column>
                                <template class="horizontal-layout">
                                    <div class="actions">
                                        <paper-icon-button id$="[[item.$key]]" noink icon="fa-icons:player-card" on-tap="_openAthleteProfileDialog"></paper-icon-button>
                                        <paper-icon-button id$="[[item.$key]]" noink icon="fa-icons:clipboard" on-tap="_openCoachProfileDialog"></paper-icon-button>
                                        <paper-icon-button id$="[[item.$key]]" noink icon="fa-icons:pdf" on-tap="_openCoachProfileDialog"></paper-icon-button>
                                        <paper-icon-button id$="[[item.$key]]" noink icon="fa-icons:file-edit" on-tap="_openCoachProfileDialog"></paper-icon-button>
                                    </div>
                                </template>
                            </vaadin-grid-column>
                        </vaadin-grid>
                    </div>
                </template>


            </div>

            <!-- Paper Fab to add new athlete -->
            <paper-fab icon="app-icons:person-add" on-tap="_openToAdd" hidden$="[[!_computeVisibleData(athletesData.length, userReady)]]"></paper-fab>
        </main>
    </template>

    <script>
        (function() {
            'use strict';

            class WrcAthletes extends Polymer.Element {
                /**
                 * Element definition
                */
                static get is() { return 'wrc-athletes'; }

                /**
                 * Element properties
                */
                static get properties() {
                    return {
                        userReady: {
                            type: Boolean,
                            notify: true,
                            value: false
                        },
                        user: {
                            type: Object,
                            notify: true,
                            observer: '_userChanged'
                        },
                        athletesData: {
                            type: Object,
                            notify: true
                        }
                    };
                }

                ready() {
                    super.ready();

                    // Athletes Dialog
                    this._athletesDialog = document.getElementById('athletesDialog');

                    // Athlete Profile Dialog
                    this._athleteProfileDialog = document.getElementById('athleteProfileDialog');

                    // App Progress Bar
                    this._appProgressBar = document.getElementById('appProgressBar');

                    // App Toast
                    this._appToast = document.getElementById('appToast');
                }

                /**
                 * Determines if the athletes data is empty to show the message
                 *
                 * @param {Number} length of the athletes array
                 * @param {Boolean} ready status of the user
                 * @return {Boolean}
                */
                _computeVisibleEmptyMessage(length, ready) {
                    if (!ready) return false;
                    return (length > 0) ? false : true;
                }

                /**
                 * Determines if the athletes data has elements to show data
                 *
                 * @param {Number} length of the athletes array
                 * @param {Boolean} ready status of the user
                 * @return {Boolean}
                */
                _computeVisibleData(length, ready) {
                    if (!ready) return false;
                    return (length > 0) ? true : false;
                }

                /**
                 * Observers the user for changes
                 *
                 * @param {Object} user information
                 * @return {void}
                */
                _userChanged(user) {
                    if (user) {
                        this.userReady = false;
						this.$.firebaseDocument.getStoredValue('/users')
                        .then(function (snapshot) {
                            this.userReady = true;
                        }.bind(this));
                    }
                }

                /**
                 * Opens coaches dialog to add
                */
                _openToAdd() {
                    this.action = 'add';
                    this._athletesDialog.dialogTitle = 'New Athlete';
                    this._athletesDialog.acceptedCallback = this._saveAthlete.bind(this);
                    this._athletesDialog.action = 'add';
                    this._athletesDialog.opened = true;
                    this._athletesDialog.user = this.user;
                }

                /**
                 * Saves athlete to database
                 *
                 * @param {Object} athleteInfo from dialog
                 * @return {void}
                */
                _saveAthlete(athleteInfo) {
					if (this.action === 'add') {
						this.$.firebaseDocument.setStoredValue('users/' + athleteInfo.uid, athleteInfo)
                        .catch(function (err) {
                            this._appToast.text = 'There has been an error. Please try again.';
                            this._appToast.open();
                        }.bind(this));
                        
						this._athletesDialog.opened = false;
						this._appToast.text = 'The athlete has been saved successfully.';
						this._appToast.open();
						this._appProgressBar.hidden = true;
					}
                }

                /**
                 * Athlete's profile dialog
                */
                _openAthleteProfileDialog(e) {
                    this.athleteId = e.target.getAttribute('id');

                    this.$.firebaseDocument.getStoredValue('users/' + this.athleteId)
                    .then(function(athleteInfo) {
                        this._athleteProfileDialog.athleteInfo = athleteInfo;
                        this._athleteProfileDialog.opened = true;
                    }.bind(this));
                }
            }
            window.customElements.define(WrcAthletes.is, WrcAthletes);
        })();
    </script>
</dom-module>